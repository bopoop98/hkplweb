<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hsig Khaung Premier League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fc;
            color: #1c1b1f;
        }
        .material-card {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease-in-out;
        }
        .material-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.08), 0 4px 8px rgba(0,0,0,0.08);
        }
        .table-header {
            background-color: #e8eaf6;
        }
        .team-logo-sm { 
            width: 28px;
            height: 28px;
            object-fit: contain; /* Use contain for logos */
        }
        .team-logo-md { 
            width: 32px; 
            height: 32px; 
            object-fit: contain; /* Use contain for logos */
        }
        .player-pic-sm {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: 50%;
            border: 1px solid #e0e0e0;
        }
        .league-header-logo {
            width: 48px; /* Same as SVG placeholder */
            height: 48px;
            object-fit: contain;
            border-radius: 8px; /* Optional: if logos can be non-square */
        }
        .primary-accent { color: #3f51b5; }
        .secondary-accent { color: #7e57c2; }
        .header-gradient { background: linear-gradient(90deg, #4A00E0 0%, #8E2DE2 100%); }
        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #333;
        }
        .match-score {
            font-size: 1.1rem; 
            font-weight: 600;
            padding: 0.2rem 0.6rem; 
            border-radius: 8px;
            background-color: #e8eaf6;
        }
        .upcoming-badge, .finished-badge, .ongoing-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .upcoming-badge { background-color: #ffeb3b; color: #333; }
        .finished-badge { background-color: #c8e6c9; color: #2e7d32; }
        .ongoing-badge { background-color: #ffcc80; color: #ef6c00; } /* Orange for ongoing */

        .table-container { overflow-x: auto; }
        th, td { white-space: nowrap; }
        .loading-text {
            text-align: center;
            padding: 1rem;
            color: #555;
            font-style: italic;
        }
    </style>
</head>
<body class="antialiased">

    <header class="header-gradient text-white p-6 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img id="leagueLogoHeader" src="https://placehold.co/48x48/FFFFFF/4A00E0?text=LCL" alt="League Logo" class="league-header-logo">
                <h1 id="leagueNameHeader" class="text-3xl font-bold tracking-tight">Hsig Khaung Premier League</h1>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="#matches" class="hover:text-yellow-300 transition-colors">Matches</a>
                <a href="#league-standings" class="hover:text-yellow-300 transition-colors">Standings</a>
                <a href="#top-scorers" class="hover:text-yellow-300 transition-colors">Top Scorers</a>
            </nav>
            <button id="mobile-menu-button" class="md:hidden focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
        <div id="mobile-menu" class="md:hidden hidden mt-3">
            <a href="#matches" class="block py-2 px-4 text-sm hover:bg-purple-700 rounded">Matches</a>
            <a href="#league-standings" class="block py-2 px-4 text-sm hover:bg-purple-700 rounded">Standings</a>
            <a href="#top-scorers" class="block py-2 px-4 text-sm hover:bg-purple-700 rounded">Top Scorers</a>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 space-y-12">

        <section id="matches">
            <h2 class="section-title primary-accent">Matches</h2>
            <div id="finished-matches-container" class="mb-10">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Finished Matches (12-24 hours ago)</h3>
                <div id="loading-finished-matches" class="loading-text">Loading finished matches...</div>
                <div id="no-recent-finished-matches" class="material-card p-6 text-center text-gray-500 hidden">
                    <p>No recently finished matches (12-24 hours ago) to display.</p>
                </div>
            </div>
            <div id="upcoming-matches-container">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Upcoming Matches</h3>
                <div id="loading-upcoming-matches" class="loading-text">Loading upcoming matches...</div>
                <div id="no-upcoming-matches" class="material-card p-6 text-center text-gray-500 hidden">
                    <p>No upcoming matches scheduled yet. Check back later!</p>
                </div>
            </div>
        </section>

        <section id="league-standings">
            <h2 class="section-title primary-accent">League Standings</h2>
            <div id="loading-standings" class="loading-text">Loading league standings...</div>
            <div class="material-card p-0 overflow-hidden hidden" id="league-standings-card">
                 <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Pos</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="min-width: 200px;">Team Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">MP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">W</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">D</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">L</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">GF</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">GA</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">GD</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Pts</th>
                            </tr>
                        </thead>
                        <tbody id="league-standings-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="top-scorers">
            <h2 class="section-title primary-accent">Top Scorers</h2>
            <div id="loading-top-scorers" class="loading-text">Loading top scorers...</div>
            <div class="material-card p-0 overflow-hidden hidden" id="top-scorers-card">
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Rank</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="min-width: 180px;">Player</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="min-width: 150px;">Team</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Goals</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Assists</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Played</th>
                            </tr>
                        </thead>
                        <tbody id="top-scorers-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="no-top-scorers" class="p-6 text-center text-gray-500 hidden">
                     <p>Top scorer data is not available yet.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300 p-8 text-center mt-12">
        <p>&copy; <span id="currentYear"></span> Local Champions League. All rights reserved.</p>
        <p class="text-sm">Powered by Firebase</p>
    </footer>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config and App ID (to be provided by the Canvas environment)
        const firebaseConfig = {                  
            apiKey: "AIzaSyDikFHg3TNUng-I9WgeTWXbO29SKxWNLZE",                  
            authDomain: "hkplweb.firebaseapp.com",                  
            projectId: "hkplweb",                  
            storageBucket: "hkplweb.firebasestorage.app",                  
            messagingSenderId: "1774261075",                  
            appId: "1:1774261075:web:cc26aa5d553dfd38ef87a6", // This is your 'measurementId' from Firebase Console web app settings                  
            measurementId: "G-XXXXXXXXXX" // Optional                
        };
        const appId = "hkplweb"; // Directly set the app ID based on your project ID

        // Initialize Firebase
        let app;
        let db;
        let auth; 

        // Global data stores
        let teamsData = [];
        let leagueDetails = {};

        // Utility to get team data by ID
        const getTeamDataById = (id) => teamsData.find(team => team.id === id);
        const defaultLogoUrl = "https://placehold.co/40x40/CCCCCC/757575?text=N/A";
        const defaultPlayerImgUrl = "https://placehold.co/36x36/CCCCCC/757575?text=P";


        // --- RENDER FUNCTIONS ---
        function renderLeagueHeader() {
            const leagueLogoHeader = document.getElementById('leagueLogoHeader');
            const leagueNameHeader = document.getElementById('leagueNameHeader');
            if (leagueDetails.LogoUrl) {
                leagueLogoHeader.src = leagueDetails.LogoUrl;
                leagueLogoHeader.onerror = () => { leagueLogoHeader.src = defaultLogoUrl; };
            } else {
                 leagueLogoHeader.src = defaultLogoUrl;
            }
            // Assuming league name might also come from 'hkpl' document or settings
            // For now, keeping the hardcoded name if not in leagueDetails.name
            leagueNameHeader.textContent = leagueDetails.name || "Hsig Khaung Premier League";
        }


        function renderMatches(matches, type) {
            const finishedContainer = document.getElementById('finished-matches-container');
            const upcomingContainer = document.getElementById('upcoming-matches-container');
            const noUpcomingDiv = document.getElementById('no-upcoming-matches');
            const noRecentFinishedDiv = document.getElementById('no-recent-finished-matches');
            const loadingFinishedDiv = document.getElementById('loading-finished-matches');
            const loadingUpcomingDiv = document.getElementById('loading-upcoming-matches');

            let container, noDataDiv, loadingDiv;

            if (type === 'finished') {
                container = finishedContainer;
                noDataDiv = noRecentFinishedDiv;
                loadingDiv = loadingFinishedDiv;
                // Clear previous content, but keep the title
                container.innerHTML = '<h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-2">Finished Matches (12-24 hours ago)</h3>';
            } else { // upcoming
                container = upcomingContainer;
                noDataDiv = noUpcomingDiv;
                loadingDiv = loadingUpcomingDiv;
                container.innerHTML = '<h3 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-2">Upcoming Matches</h3>';
            }
            
            loadingDiv.classList.add('hidden'); // Hide loading indicator

            if (matches.length === 0) {
                noDataDiv.classList.remove('hidden');
                container.appendChild(noDataDiv);
                return;
            }
            noDataDiv.classList.add('hidden');

            // Group finished matches by date if applicable
            if (type === 'finished') {
                const groupedMatches = matches.reduce((acc, match) => {
                    const date = new Date(match.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(match);
                    return acc;
                }, {});

                let matchesHTML = '';
                for (const date in groupedMatches) {
                    const dateHeaderEl = document.createElement('h4');
                    dateHeaderEl.className = 'text-lg font-medium text-gray-600 mt-4 mb-2';
                    dateHeaderEl.textContent = date;
                    container.appendChild(dateHeaderEl);

                    groupedMatches[date].forEach(match => {
                        matchesHTML += generateMatchCardHTML(match);
                    });
                }
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = matchesHTML;
                while(tempDiv.firstChild) container.appendChild(tempDiv.firstChild);

            } else { // Upcoming matches (not grouped by date in this layout)
                let matchesHTML = '';
                matches.forEach(match => {
                    matchesHTML += generateMatchCardHTML(match);
                });
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = matchesHTML;
                while(tempDiv.firstChild) container.appendChild(tempDiv.firstChild);
            }
        }

        function generateMatchCardHTML(match) {
            const homeTeam = getTeamDataById(match.homeTeamId);
            const awayTeam = getTeamDataById(match.awayTeamId);

            if (!homeTeam || !awayTeam) {
                console.warn("Team data missing for match:", match.id, "Home:", match.homeTeamId, "Away:", match.awayTeamId);
                return `<div class="material-card p-4 mb-3 text-red-500">Error: Team data missing for this match.</div>`;
            }

            const matchDateStr = new Date(match.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            let statusBadge = '';
            let scoreOrVs = '';

            switch(match.status) {
                case 'finished':
                    statusBadge = `<span class="finished-badge">Finished</span>`;
                    scoreOrVs = `<div class="match-score text-base md:text-lg font-bold primary-accent mx-1.5">${match.homeScore} - ${match.awayScore}</div>`;
                    break;
                case 'upcoming':
                    statusBadge = `<span class="upcoming-badge">Upcoming</span>`;
                    scoreOrVs = `<div class="text-xl font-bold secondary-accent mx-1.5">VS</div>`;
                    break;
                case 'ongoing':
                    statusBadge = `<span class="ongoing-badge">Ongoing</span>`;
                    scoreOrVs = `<div class="match-score text-base md:text-lg font-bold primary-accent mx-1.5">${match.homeScore} - ${match.awayScore}</div>`;
                    break;
                default:
                    statusBadge = `<span class="text-xs text-gray-400">${match.status}</span>`;
                    scoreOrVs = `<div class="text-xl font-bold secondary-accent mx-1.5">VS</div>`;
            }
            
            return `
                <div class="material-card p-4 mb-3"> 
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs text-gray-500">${match.status === 'upcoming' ? matchDateStr + ' - ' : ''}${match.time}</span>
                        ${statusBadge}
                    </div>
                    <div class="flex items-center justify-around text-center">
                        <div class="flex flex-col items-center w-2/5">
                            <img src="${homeTeam.LogoUrl || defaultLogoUrl}" alt="${homeTeam.name}" class="team-logo-md mb-1" onerror="this.src='${defaultLogoUrl}'">
                            <span class="font-semibold text-xs md:text-sm truncate w-full" title="${homeTeam.name}">${homeTeam.name}</span> 
                        </div>
                        ${scoreOrVs}
                        <div class="flex flex-col items-center w-2/5">
                            <img src="${awayTeam.LogoUrl || defaultLogoUrl}" alt="${awayTeam.name}" class="team-logo-md mb-1" onerror="this.src='${defaultLogoUrl}'">
                            <span class="font-semibold text-xs md:text-sm truncate w-full" title="${awayTeam.name}">${awayTeam.name}</span> 
                        </div>
                    </div>
                </div>
            `;
        }


        function renderLeagueStandings(teams) {
            const tbody = document.getElementById('league-standings-body');
            const loadingDiv = document.getElementById('loading-standings');
            const cardDiv = document.getElementById('league-standings-card');
            
            loadingDiv.classList.add('hidden');
            cardDiv.classList.remove('hidden');
            tbody.innerHTML = '';

            if (!teams || teams.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" class="text-center py-4">No teams found or data is loading.</td></tr>`;
                return;
            }

            const standings = teams.map(team => {
                const gd = (team.gf || 0) - (team.ga || 0);
                const pts = (team.won || 0) * 3 + (team.draw || 0);
                return { ...team, gd, pts };
            }).sort((a, b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.name.localeCompare(b.name));

            let rowsHTML = '';
            standings.forEach((team, index) => {
                rowsHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-50 transition-colors">
                        <td class="px-4 py-4 text-sm font-medium text-gray-700">${index + 1}</td> 
                        <td class="px-4 py-4"><img src="${team.LogoUrl || defaultLogoUrl}" alt="${team.name}" class="team-logo-sm" onerror="this.src='${defaultLogoUrl}'"></td> 
                        <td class="px-4 py-4 text-sm font-medium text-gray-900 truncate" style="max-width: 200px;" title="${team.name}">${team.name}</td>
                        <td class="px-4 py-4 text-sm text-gray-600">${team.played || 0}</td>
                        <td class="px-4 py-4 text-sm text-gray-600">${team.won || 0}</td>
                        <td class="px-4 py-4 text-sm text-gray-600">${team.draw || 0}</td>
                        <td class="px-4 py-4 text-sm text-gray-600">${team.lost || 0}</td>
                        <td class="px-4 py-4 text-sm text-gray-600">${team.gf || 0}</td>
                        <td class="px-4 py-4 text-sm text-gray-600">${team.ga || 0}</td>
                        <td class="px-4 py-4 text-sm text-gray-600">${team.gd > 0 ? '+' : ''}${team.gd}</td>
                        <td class="px-4 py-4 text-sm font-bold text-indigo-700">${team.pts}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = rowsHTML;
        }

        function renderTopScorers(players) {
            const tbody = document.getElementById('top-scorers-table-body');
            const noTopScorersDiv = document.getElementById('no-top-scorers');
            const loadingDiv = document.getElementById('loading-top-scorers');
            const cardDiv = document.getElementById('top-scorers-card');
            
            loadingDiv.classList.add('hidden');
            cardDiv.classList.remove('hidden');
            tbody.innerHTML = ''; 

            if (!players || players.length === 0) {
                noTopScorersDiv.classList.remove('hidden');
                tbody.closest('.table-container').classList.add('hidden'); // Hide table if no data
                return;
            }
            
            noTopScorersDiv.classList.add('hidden');
            tbody.closest('.table-container').classList.remove('hidden'); // Show table

            const sortedScorers = players
                .filter(p => (p.goals || 0) > 0) // Only show players with goals
                .sort((a, b) => (b.goals || 0) - (a.goals || 0) || (b.assists || 0) - (a.assists || 0) || (a.matchesPlayed || 0) - (b.matchesPlayed || 0));

            if (sortedScorers.length === 0) {
                 noTopScorersDiv.classList.remove('hidden');
                 tbody.closest('.table-container').classList.add('hidden');
                 return;
            }


            let rowsHTML = '';
            sortedScorers.forEach((scorer, index) => {
                const team = getTeamDataById(scorer.team_id); // team_id from Firestore
                rowsHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-50 transition-colors">
                        <td class="px-4 py-3 text-sm font-medium text-gray-700">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">
                            <div class="flex items-center space-x-2.5">
                                <img src="${scorer.imageUrl || defaultPlayerImgUrl}" alt="${scorer.name}" class="player-pic-sm" onerror="this.src='${defaultPlayerImgUrl}'">
                                <span class="truncate" style="max-width: 120px;" title="${scorer.name}">${scorer.name}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            ${team ? `<img src="${team.LogoUrl || defaultLogoUrl}" alt="${team.name}" class="team-logo-sm" onerror="this.src='${defaultLogoUrl}'">` : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600 truncate" style="max-width: 150px;" title="${team ? team.name : 'N/A'}">${team ? team.name : 'N/A'}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-indigo-700">${scorer.goals || 0}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${scorer.assists || 0}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${scorer.matchesPlayed || 0}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = rowsHTML;
        }

        // --- Firebase Initialization and Data Listeners ---
        async function signInAndSetupListeners() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                setLogLevel('debug'); // For development

                // Data will be read based on Firebase Security Rules (e.g., allow public read).
                setupFirestoreListeners();
                console.log("Firebase initialized and Firestore listeners set up for public data access.");

            } catch (error) {
                console.error("Firebase initialization error:", error);
                // Display error to user on the page
                document.body.innerHTML = `<div class="p-4 text-red-500">Error initializing Firebase. Please check console. AppId: ${appId}</div>`;
            }
        }

        function setupFirestoreListeners() {
            // Listener for League Details (e.g., LogoUrl)
            const leagueDetailsPath = `artifacts/${appId}/public/data/leagues/hkpl`;
            onSnapshot(doc(db, leagueDetailsPath), (docSnap) => {
                if (docSnap.exists()) {
                    leagueDetails = { id: docSnap.id, ...docSnap.data() };
                    console.log("League details updated:", leagueDetails);
                    renderLeagueHeader();
                } else {
                    console.log("No such league details document!");
                    leagueDetails = {}; 
                    renderLeagueHeader(); 
                }
            }, (error) => console.error("Error fetching league details:", error));

            // Listener for Teams
            const teamsPath = `artifacts/${appId}/public/data/leagues/hkpl/teams`;
            onSnapshot(collection(db, teamsPath), (snapshot) => {
                teamsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Teams data updated:", teamsData);
                renderLeagueStandings(teamsData);
            }, (error) => console.error("Error fetching teams:", error));

            // Listener for Matches
            const matchesPath = `artifacts/${appId}/public/data/leagues/hkpl/matches`;
            onSnapshot(collection(db, matchesPath), (snapshot) => {
                const allMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Matches data updated:", allMatches);

                // Current time for filtering
                const now = new Date(); 
                const twelveHoursInMs = 12 * 60 * 60 * 1000;
                const oneDayInMs = 24 * 60 * 60 * 1000;
                const twelveHoursAgo = new Date(now.getTime() - twelveHoursInMs);
                const oneDayAgo = new Date(now.getTime() - oneDayInMs);

                const finishedMatches = allMatches.filter(m => {
                    if (m.status !== 'finished') return false;
                    const matchDateTimeStr = `${m.date}T${m.time || '00:00:00'}`;
                    const matchDateTime = new Date(matchDateTimeStr);
                    return matchDateTime < twelveHoursAgo && matchDateTime >= oneDayAgo;
                }).sort((a,b) => new Date(`${b.date}T${b.time || '00:00:00'}`) - new Date(`${a.date}T${a.time || '00:00:00'}`));
                
                const upcomingMatches = allMatches
                    .filter(m => m.status === 'upcoming')
                    .sort((a,b) => new Date(a.date) - new Date(b.date) || (a.time || "00:00").localeCompare(b.time || "00:00"));

                renderMatches(finishedMatches, 'finished');
                renderMatches(upcomingMatches, 'upcoming');

            }, (error) => console.error("Error fetching matches:", error));

            // Listener for Players (Top Scorers)
            const playersPath = `artifacts/${appId}/public/data/leagues/hkpl/players`;
            onSnapshot(collection(db, playersPath), (snapshot) => {
                const players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Players data updated:", players);
                renderTopScorers(players);
            }, (error) => console.error("Error fetching players:", error));
            
            // Listener for Settings (optional, if needed for UI)
            const settingsPath = `artifacts/${appId}/public/data/leagues/hkpl/settings/config`;
            onSnapshot(doc(db, settingsPath), (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Settings updated:", docSnap.data());
                } else {
                    console.log("No such settings document!");
                }
            }, (error) => console.error("Error fetching settings:", error));
        }


        // --- INITIALIZE ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            signInAndSetupListeners(); 

            // Mobile menu toggle
            const menuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            menuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        });
    </script>
</body>
</html>
