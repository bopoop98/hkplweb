<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Football League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        header {
            background-color: #1e3a8a; /* Dark blue */
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .nav-item:hover {
            background-color: #3b82f6; /* Blue-500 */
        }
        .table-header th {
            background-color: #1e3a8a; /* Dark blue */
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .section-title {
            border-bottom: 2px solid #1e3a8a; /* Dark blue */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            color: #1e3a8a;
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
        }
        .card {
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: #1a202c; /* Darker blue-gray */
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }
        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 20px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }
        .sidenav a:hover {
            color: #f1f1f1;
        }
        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }
        @media screen and (max-height: 450px) {
            .sidenav {padding-top: 15px;}
            .sidenav a {font-size: 18px;}
        }

        /* Responsive table behavior */
        @media (max-width: 768px) {
            table.responsive-table {
                border: 0;
            }
            table.responsive-table thead {
                display: none;
            }
            table.responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #ddd;
                border-radius: 0.5rem;
                background-color: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            table.responsive-table td {
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
            }
            table.responsive-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 45%;
                padding-left: 1rem;
                font-weight: bold;
                text-align: left;
                color: #555;
            }
            table.responsive-table td:first-child {
                border-top-left-radius: 0.5rem;
                border-top-right-radius: 0.5rem;
            }
            table.responsive-table td:last-child {
                border-bottom-left-radius: 0.5rem;
                border-bottom-right-radius: 0.5rem;
            }
            .team-name-cell {
                justify-content: flex-end; /* Align content to right */
            }
            .team-name-cell .flex {
                width: 100%;
                justify-content: flex-end; /* Ensure flex content aligns right */
            }
            .team-name-cell img {
                margin-right: auto; /* Push image to the left within the flex container */
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button id="hamburger-menu" class="text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 id="main-title" class="text-2xl font-bold">Local Football League</h1>
            </div>
            <div class="flex space-x-2">
                <button id="lang-en" class="lang-button px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-sm active" data-lang="en">EN</button>
                <button id="lang-my" class="lang-button px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-sm" data-lang="my">MY</button>
            </div>
        </div>
    </header>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" id="close-nav">&times;</a>
        <a href="#" class="nav-item" id="nav-home">Home</a>
        <a href="#" class="nav-item hidden" id="nav-admin-dashboard">Admin Dashboard</a>
        <a href="#" class="nav-item" id="nav-login">Login / Admin Access</a>
    </div>

    <main class="container py-6">
        <section id="upcoming-matches">
            <h2 class="section-title mb-4" data-key="upcomingMatchesTitle">Upcoming Matches This Week</h2>
            <div id="matches-list" class="bg-white p-4 rounded-lg shadow min-h-[100px] flex items-center justify-center">
                <p class="text-gray-600" data-key="loadingMatches">Loading matches...</p>
            </div>
        </section>

        <section id="league-standings" class="mt-8">
            <h2 class="section-title mb-4" data-key="leagueStandingsTitle">League Standings</h2>
            <div class="overflow-x-auto bg-white rounded-lg shadow">
                <table class="min-w-full responsive-table">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3 text-sm" data-key="posHeader">Pos</th>
                            <th class="p-3 text-sm" data-key="teamHeader">Team</th>
                            <th class="p-3 text-sm" data-key="pHeader">P</th>
                            <th class="p-3 text-sm" data-key="wHeader">W</th>
                            <th class="p-3 text-sm" data-key="dHeader">D</th>
                            <th class="p-3 text-sm" data-key="lHeader">L</th>
                            <th class="p-3 text-sm" data-key="gfHeader">GF</th>
                            <th class="p-3 text-sm" data-key="gaHeader">GA</th>
                            <th class="p-3 text-sm" data-key="gdHeader">GD</th>
                            <th class="p-3 text-sm" data-key="ptsHeader">Pts</th>
                        </tr>
                    </thead>
                    <tbody id="standings-body" class="divide-y divide-gray-200">
                        <tr><td colspan="10" class="text-gray-600 text-center p-4" data-key="loadingStandings">Loading standings...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="top-scorers" class="mt-8">
            <h2 class="section-title mb-4" data-key="topScorersTitle">Top Scorers</h2>
            <div id="scorers-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <p class="text-gray-600 text-center col-span-full" data-key="loadingScorers">Loading top scorers...</p>
            </div>
        </section>

        <section id="admin-dashboard" class="mt-8 hidden">
            <h2 class="section-title mb-4">Admin Dashboard</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="manage-teams-btn" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Manage Teams</button>
                    <button id="manage-players-btn" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Manage Players</button>
                    <button id="manage-matches-btn" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Manage Matches</button>
                </div>
                <div id="admin-content-area" class="border border-gray-200 p-4 rounded-lg bg-gray-50 min-h-[200px]">
                    <p class="text-gray-600">Select an option above to manage league data.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-10">
        <div class="container text-center text-sm">
            <p>&copy; <span id="current-year"></span> <span data-key="footerLeagueName">Local Football League</span>. <span data-key="footerRights">All rights reserved.</span></p>
            <p class="text-xs mt-2" data-key="dataLastUpdatedPrefix">Data last updated: <span id="data-last-updated">Not available</span></p>
        </div>
    </footer>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-login-modal">&times;</span>
            <h2 class="text-xl font-bold mb-4">Admin Login</h2>
            <div class="mb-4">
                <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="login-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="admin@example.com">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                <input type="password" id="login-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="********">
            </div>
            <p id="login-error-message" class="text-red-500 text-xs italic mb-4 hidden"></p>
            <button id="login-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                Login
            </button>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase variables (globally accessible within this script module)
        let app;
        let db;
        let auth;
        let userId = null; // Initialize to null
        let isAdmin = false; // Flag to track admin status
        let firebaseAppId = null; // Will store the actual appId from config

        // Global data stores (will be populated from Firestore)
        let allTeams = [];
        let allPlayers = [];
        let allMatches = [];
        let adminUids = []; // Stores UIDs of admin users
        let lastUpdatedTimestamp = null; // To store the last updated time from Firestore settings

        // --- LANGUAGE TRANSLATIONS ---
        const translations = {
            en: {
                mainTitle: "Local Football League",
                upcomingMatchesTitle: "Upcoming Matches This Week",
                loadingMatches: "Loading matches...",
                noUpcomingMatches: "No upcoming matches scheduled for this week.",
                live: "LIVE",
                ft: "FT",
                leagueStandingsTitle: "League Standings",
                loadingStandings: "Loading standings...",
                noStandingsData: "No standings data available.",
                posHeader: "Pos",
                teamHeader: "Team",
                pHeader: "P",
                wHeader: "W",
                dHeader: "D",
                lHeader: "L",
                gfHeader: "GF",
                gaHeader: "GA",
                gdHeader: "GD",
                ptsHeader: "Pts",
                topScorersTitle: "Top Scorers",
                loadingScorers: "Loading top scorers...",
                noScorersData: "No top scorers data available.",
                mp: "MP",
                g: "G",
                a: "A",
                vs: "vs",
                footerLeagueName: "Local Football League",
                footerRights: "All rights reserved.",
                dataLastUpdatedPrefix: "Data last updated:"
            },
            my: { // Myanmar translations (simplified for example)
                mainTitle: "ပြည်တွင်းဘောလုံးလိဂ်",
                upcomingMatchesTitle: "လာမည့်ပွဲစဉ်များ",
                loadingMatches: "ပွဲစဉ်များ တင်နေသည်...",
                noUpcomingMatches: "ယခုသီတင်းပတ်အတွက် လာမည့်ပွဲစဉ်များ မရှိပါ။",
                live: "တိုက်ရိုက်",
                ft: "ပွဲပြီး",
                leagueStandingsTitle: "လိဂ်ရပ်တည်မှု",
                loadingStandings: "ရပ်တည်မှုများ တင်နေသည်...",
                noStandingsData: "ရပ်တည်မှုဒေတာ မရှိပါ။",
                posHeader: "အဆင့်",
                teamHeader: "အသင်း",
                pHeader: "ပွဲ",
                wHeader: "နိုင်",
                dHeader: "သရေ",
                lHeader: "ရှုံး",
                gfHeader: "သွင်း",
                gaHeader: "ပေး",
                gdHeader: "ဂိုးကွာ",
                ptsHeader: "ရမှတ်",
                topScorersTitle: "ဂိုးသွင်းအများဆုံးများ",
                loadingScorers: "ဂိုးသွင်းအများဆုံးများ တင်နေသည်...",
                noScorersData: "ဂိုးသွင်းအများဆုံးဒေတာ မရှိပါ။",
                mp: "ပွဲ",
                g: "ဂိုး",
                a: "ဖန်",
                vs: "နှင့်",
                footerLeagueName: "ပြည်တွင်းဘောလုံးလိဂ်",
                footerRights: "အခွင့်အရေးများအားလုံး ကာကွယ်ထားပါသည်။",
                dataLastUpdatedPrefix: "ဒေတာ နောက်ဆုံးအပ်ဒိတ်လုပ်သည်:"
            }
        };

        let currentLanguage = localStorage.getItem('preferredLanguage') || 'en'; // Default to English

        // --- LANGUAGE SWITCHER FUNCTION ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang); // Save preference

            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            document.getElementById('main-title').textContent = translations[lang].mainTitle;
            renderAllData(); // Re-render data to apply new language
            
            document.querySelectorAll('.lang-button').forEach(button => {
                if (button.dataset.lang === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // --- UTILITY FUNCTIONS ---
        function getTeamById(teamId) {
            return allTeams.find(team => team.id === teamId);
        }

        function getPlayerById(playerId) {
            return allPlayers.find(player => player.id === playerId);
        }

        function getMatchStatusAndDisplay(match) {
            const MATCH_DURATION_MINUTES = 90;
            const matchDateTime = new Date(`${match.date}T${match.time}:00`);
            const now = new Date();
            const matchEndTime = new Date(matchDateTime.getTime() + (MATCH_DURATION_MINUTES * 60 * 1000));

            const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
            const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };

            if (now >= matchDateTime && now <= matchEndTime) {
                return {
                    status: 'ongoing',
                    display: translations[currentLanguage].live,
                    scoreDisplay: `${match.homeScore} - ${match.awayScore}`
                };
            } else if (now < matchDateTime) {
                const displayDateTime = `${matchDateTime.toLocaleDateString(undefined, dateOptions)} ${matchDateTime.toLocaleTimeString(undefined, timeOptions)}`;
                return {
                    status: 'upcoming',
                    display: displayDateTime
                };
            } else {
                return {
                    status: 'finished',
                    display: translations[currentLanguage].ft,
                    scoreDisplay: `${match.homeScore} - ${match.awayScore}`
                };
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderStandings() {
            const standingsBody = document.getElementById('standings-body');
            if (!standingsBody) return;
            standingsBody.innerHTML = '';

            if (allTeams.length === 0) {
                 standingsBody.innerHTML = `<tr><td colspan="10" class="text-gray-600 text-center p-4">${translations[currentLanguage].noStandingsData}</td></tr>`;
                 return;
            }

            const teamsWithPoints = allTeams.map(team => ({
                ...team,
                pts: (team.won * 3) + (team.drawn * 1),
                gd: (team.gf || 0) - (team.ga || 0)
            }));

            const sortedTeams = [...teamsWithPoints].sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                if (b.gd !== a.gd) return b.gd - a.gd;
                return b.gf - a.gf;
            });

            sortedTeams.forEach((team, index) => {
                const row = standingsBody.insertRow();
                row.innerHTML = `
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].posHeader}">${index + 1}</td>
                    <td class="p-3 text-sm text-gray-900 font-medium team-name-cell" data-label="${translations[currentLanguage].teamHeader}">
                        <div class="flex items-center">
                            <img src="${team.logoUrl}" alt="${team.name} logo" class="w-6 h-6 mr-2 rounded-full" onerror="this.src='https://placehold.co/40x40/CCCCCC/FFFFFF?text=N/A';">
                            ${team.name}
                        </div>
                    </td>
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].pHeader}">${team.played || 0}</td>
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].wHeader}">${team.won || 0}</td>
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].dHeader}">${team.drawn || 0}</td>
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].lHeader}">${team.lost || 0}</td>
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].gfHeader}">${team.gf || 0}</td>
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].gaHeader}">${team.ga || 0}</td>
                    <td class="p-3 text-sm text-gray-700 whitespace-nowrap" data-label="${translations[currentLanguage].gdHeader}">${team.gd > 0 ? '+' : ''}${team.gd}</td>
                    <td class="p-3 text-sm text-gray-900 font-bold whitespace-nowrap" data-label="${translations[currentLanguage].ptsHeader}">${team.pts}</td>
                `;
            });
        }

        function renderTopScorers() {
            const scorersGrid = document.getElementById('scorers-grid');
            if (!scorersGrid) return;
            scorersGrid.innerHTML = '';

            if (allPlayers.length === 0) {
                scorersGrid.innerHTML = `<p class="text-gray-600 text-center col-span-full">${translations[currentLanguage].noScorersData}</p>`;
                return;
            }

            const sortedScorers = [...allPlayers].sort((a,b) => {
                if ((b.goals || 0) !== (a.goals || 0)) return (b.goals || 0) - (a.goals || 0);
                return (b.assists || 0) - (a.assists || 0);
            }).slice(0, 5);

            sortedScorers.forEach(scorer => {
                const team = getTeamById(scorer.teamId);
                const card = document.createElement('div');
                card.className = 'card p-4 flex flex-col items-center text-center'; 
                card.innerHTML = `
                    <img src="${scorer.imageUrl}" alt="${scorer.name}" class="w-20 h-20 rounded-full mb-3 object-cover shadow-lg" onerror="this.src='https://placehold.co/80x80/CCCCCC/FFFFFF?text=N/A';">
                    <h3 class="text-lg font-semibold text-blue-600">${scorer.name}</h3>
                    <p class="text-sm text-gray-600">${team ? team.name : 'N/A'}</p>
                    <div class="mt-2 text-xs text-gray-500">
                        <span>${translations[currentLanguage].mp}: ${scorer.matchesPlayed || 0}</span> |
                        <span class="font-bold text-green-600">${translations[currentLanguage].g}: ${scorer.goals || 0}</span> |
                        <span>${translations[currentLanguage].a}: ${scorer.assists || 0}</span>
                    </div>
                `;
                scorersGrid.appendChild(card);
            });
        }

        function renderUpcomingMatches() {
            const matchesListDiv = document.getElementById('matches-list');
            if (!matchesListDiv) return;
            matchesListDiv.innerHTML = '';

            if (allMatches.length === 0) {
                matchesListDiv.innerHTML = `<p class="text-gray-600 text-center">${translations[currentLanguage].noUpcomingMatches}</p>`;
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const currentDayOfWeek = today.getDay();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - currentDayOfWeek);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23,59,59,999);

            const matchesThisWeek = allMatches.filter(match => {
                const matchDate = new Date(match.date + 'T00:00:00');
                return matchDate >= startOfWeek && matchDate <= endOfWeek;
            });
            
            matchesThisWeek.sort((a,b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateA - dateB;
            });

            if (matchesThisWeek.length === 0) {
                matchesListDiv.innerHTML = `<p class="text-gray-600 text-center">${translations[currentLanguage].noUpcomingMatches}</p>`;
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'space-y-2 bg-white p-4 rounded-lg shadow';

            matchesThisWeek.forEach(match => {
                const team1 = getTeamById(match.homeTeamId);
                const team2 = getTeamById(match.awayTeamId);
                
                const matchInfo = getMatchStatusAndDisplay(match);

                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 rounded-md hover:bg-gray-50 transition-colors';
                
                if (matchInfo.status === 'ongoing') {
                    li.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
                }

                li.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <img src="${team1 ? team1.logoUrl : ''}" alt="${team1 ? team1.name : 'N/A'}" class="w-5 h-5 rounded-full" onerror="this.src='https://placehold.co/40x40/CCCCCC/FFFFFF?text=N/A'"/>
                        <span class="font-medium text-gray-700">${team1 ? team1.name : 'N/A'}</span>
                        <span class="text-gray-500">${translations[currentLanguage].vs}</span>
                        <img src="${team2 ? team2.logoUrl : ''}" alt="${team2 ? team2.name : 'N/A'}" class="w-5 h-5 rounded-full" onerror="this.src='https://placehold.co/40x40/CCCCCC/FFFFFF?text=N/A'"/>
                        <span class="font-medium text-gray-700">${team2 ? team2.name : 'N/A'}</span>
                    </div>
                    <div class="text-right">
                        ${matchInfo.status === 'ongoing' ?
                            `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 animate-pulse">${translations[currentLanguage].live}</span>
                             <span class="ml-2 text-lg font-bold text-blue-700">${matchInfo.scoreDisplay}</span>`
                            : matchInfo.status === 'finished' ?
                            `<span class="text-sm text-gray-500 font-semibold">${translations[currentLanguage].ft}</span>
                             <span class="ml-1 text-base font-bold text-gray-800">${matchInfo.scoreDisplay}</span>`
                            :
                            `<span class="text-sm text-blue-600 font-semibold">${matchInfo.display}</span>`
                        }
                    </div>
                `;
                ul.appendChild(li);
            });
            matchesListDiv.appendChild(ul);
        }
        
        // --- FOOTER ---
        function updateFooter() {
            const yearSpan = document.getElementById('current-year');
            if (yearSpan) yearSpan.textContent = new Date().getFullYear();

            const lastUpdatedSpan = document.getElementById('data-last-updated');
            if (lastUpdatedSpan && lastUpdatedTimestamp) {
                const lastUpdateDate = new Date(lastUpdatedTimestamp);
                 lastUpdatedSpan.textContent = lastUpdateDate.toLocaleDateString(undefined, {
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            } else if (lastUpdatedSpan) {
                lastUpdatedSpan.textContent = "Not available";
            }
        }

        // --- UI VISIBILITY FUNCTIONS ---
        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function toggleLoginModal(show) {
            const modal = document.getElementById('login-modal');
            if (show) {
                modal.classList.add('show');
            } else {
                modal.classList.remove('show');
                document.getElementById('login-error-message').classList.add('hidden');
            }
        }

        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }

        function updateAdminUI() {
            const adminDashboardLink = document.getElementById('nav-admin-dashboard');
            if (isAdmin) {
                adminDashboardLink.classList.remove('hidden');
            } else {
                adminDashboardLink.classList.add('hidden');
                if (!document.getElementById('admin-dashboard').classList.contains('hidden')) {
                    showSection('upcoming-matches');
                }
            }
        }

        // --- AUTHENTICATION FUNCTIONS ---
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorMessageElement = document.getElementById('login-error-message');
            errorMessageElement.classList.add('hidden');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Logged in:", userCredential.user.uid);
                toggleLoginModal(false);
                closeNav();
                // onAuthStateChanged listener will handle isAdmin check and UI update
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                let displayMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    displayMessage = "Invalid email or password.";
                } else if (error.code === 'auth/invalid-email') {
                    displayMessage = "Invalid email format.";
                } else if (error.code === 'auth/too-many-requests') {
                    displayMessage = "Too many login attempts. Please try again later.";
                }
                errorMessageElement.textContent = displayMessage;
                errorMessageElement.classList.remove('hidden');
            }
        }

        async function checkAdminStatus(uid) {
            try {
                const configDocRef = doc(db, `/artifacts/${firebaseAppId}/public/data/leagues/${LEAGUE_ID}/settings/config`);
                const configSnap = await getDoc(configDocRef);
                if (configSnap.exists()) {
                    const configData = configSnap.data();
                    adminUids = configData.adminUids || [];
                    return adminUids.includes(uid);
                }
                return false;
            } catch (error) {
                console.error("Error checking admin status:", error);
                return false;
            }
        }

        // --- FETCH DATA FROM FIRESTORE ---
        const LEAGUE_ID = 'hkpl'; // This should match your league ID in Firestore

        async function fetchFirestoreData() {
            if (!firebaseAppId) {
                console.error("Firebase App ID is not set. Cannot fetch Firestore data.");
                document.getElementById('matches-list').innerHTML = `<p class="text-red-500 text-center">Firebase not configured. Check console.</p>`;
                document.getElementById('standings-body').innerHTML = `<tr><td colspan="10" class="text-red-500 text-center p-4">Firebase not configured.</td></tr>`;
                document.getElementById('scorers-grid').innerHTML = `<p class="text-red-500 text-center col-span-full">Firebase not configured.</p>`;
                return;
            }

            try {
                // Fetch Teams
                onSnapshot(collection(db, `/artifacts/${firebaseAppId}/public/data/leagues/${LEAGUE_ID}/teams`), (snapshot) => {
                    allTeams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllData();
                    console.log("Teams fetched:", allTeams);
                }, (error) => {
                    console.error("Error fetching teams:", error);
                    document.getElementById('standings-body').innerHTML = `<tr><td colspan="10" class="text-red-500 text-center p-4">Error loading teams.</td></tr>`;
                });

                // Fetch Players
                onSnapshot(collection(db, `/artifacts/${firebaseAppId}/public/data/leagues/${LEAGUE_ID}/players`), (snapshot) => {
                    allPlayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllData();
                    console.log("Players fetched:", allPlayers);
                }, (error) => {
                    console.error("Error fetching players:", error);
                    document.getElementById('scorers-grid').innerHTML = `<p class="text-red-500 text-center col-span-full">Error loading players.</p>`;
                });

                // Fetch Matches
                onSnapshot(collection(db, `/artifacts/${firebaseAppId}/public/data/leagues/${LEAGUE_ID}/matches`), (snapshot) => {
                    allMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllData();
                    console.log("Matches fetched:", allMatches);
                }, (error) => {
                    console.error("Error fetching matches:", error);
                    document.getElementById('matches-list').innerHTML = `<p class="text-red-500 text-center">Error loading matches.</p>`;
                });

                // Fetch Settings for last updated timestamp and admin UIDs
                onSnapshot(doc(db, `/artifacts/${firebaseAppId}/public/data/leagues/${LEAGUE_ID}/settings/config`), (docSnap) => {
                    if (docSnap.exists()) {
                        const configData = docSnap.data();
                        lastUpdatedTimestamp = configData.lastUpdated?.toDate() || null;
                        adminUids = configData.adminUids || [];
                        updateFooter();
                        if (auth.currentUser) { // Re-check admin status if current user is logged in
                            isAdmin = adminUids.includes(auth.currentUser.uid);
                        } else { // If no user is logged in (public view)
                            isAdmin = false;
                        }
                        updateAdminUI(); // Always update UI based on current isAdmin status
                    } else {
                        console.warn("No config document found in settings. Ensure you've created /artifacts/{appId}/public/data/leagues/{LEAGUE_ID}/settings/config in Firestore.");
                        lastUpdatedTimestamp = null;
                        adminUids = [];
                        updateFooter();
                        isAdmin = false;
                        updateAdminUI();
                    }
                    console.log("Settings fetched. Last updated:", lastUpdatedTimestamp, "Admin UIDs:", adminUids);
                }, (error) => {
                    console.error("Error fetching settings:", error);
                });

            } catch (error) {
                console.error("Error initializing Firestore data listeners:", error);
            }
        }

        // --- RENDER ALL DATA ---
        function renderAllData() {
            renderUpcomingMatches();
            renderStandings();
            renderTopScorers();
            updateFooter();
        }

        // --- INITIALIZE PAGE ---
        document.addEventListener('DOMContentLoaded', async () => {
            setLanguage(currentLanguage);

            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-my').addEventListener('click', () => setLanguage('my'));

            document.getElementById('hamburger-menu').addEventListener('click', openNav);
            document.getElementById('close-nav').addEventListener('click', closeNav);
            document.getElementById('nav-home').addEventListener('click', () => {
                showSection('upcoming-matches');
                closeNav();
            });
            document.getElementById('nav-login').addEventListener('click', () => {
                toggleLoginModal(true);
                closeNav();
            });
            document.getElementById('nav-admin-dashboard').addEventListener('click', () => {
                showSection('admin-dashboard');
                closeNav();
            });

            document.getElementById('close-login-modal').addEventListener('click', () => toggleLoginModal(false));
            document.getElementById('login-button').addEventListener('click', handleLogin);

            document.getElementById('manage-teams-btn').addEventListener('click', () => {
                document.getElementById('admin-content-area').innerHTML = `<h3 class="text-xl font-semibold mb-2">Manage Teams</h3><p>Forms to add/edit/delete teams will go here.</p>`;
            });
            document.getElementById('manage-players-btn').addEventListener('click', () => {
                document.getElementById('admin-content-area').innerHTML = `<h3 class="text-xl font-semibold mb-2">Manage Players</h3><p>Forms to add/edit/delete players will go here.</p>`;
            });
            document.getElementById('manage-matches-btn').addEventListener('click', () => {
                document.getElementById('admin-content-area').innerHTML = `<h3 class="text-xl font-semibold mb-2">Manage Matches</h3><p>Forms to add/edit/delete matches will go here.</p>`;
            });


            // Initialize Firebase
            try {
                // *** PASTE YOUR FIREBASE CONFIG OBJECT HERE ***
                const firebaseConfig = {
                  apiKey: "AIzaSyDikFHg3TNUng-I9WgeTWXbO29SKxWNLZE",
                  authDomain: "hkplweb.firebaseapp.com",
                  projectId: "hkplweb",
                  storageBucket: "hkplweb.firebasestorage.app",
                  messagingSenderId: "1774261075",
                  appId: "1:1774261075:web:cc26aa5d553dfd38ef87a6", // This is your 'measurementId' from Firebase Console web app settings
                  measurementId: "G-XXXXXXXXXX" // Optional
                };
                // ********************************************

                // Store appId globally for use in Firestore paths
                firebaseAppId = firebaseConfig.projectId;

                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes (for admin login/logout)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // A user (potentially an admin) is logged in
                        userId = user.uid;
                        console.log("Firebase Authenticated. User ID:", userId);
                        isAdmin = await checkAdminStatus(userId);
                    } else {
                        // No user is logged in (public view)
                        console.log("Firebase Not Authenticated (public view).");
                        userId = null;
                        isAdmin = false;
                    }
                    updateAdminUI(); // Update UI based on current isAdmin status
                    // Always fetch data regardless of authentication state, as read rules are public
                    fetchFirestoreData();
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                document.getElementById('matches-list').innerHTML = `<p class="text-red-500 text-center">Failed to load league data. Please check console for errors.</p>`;
                document.getElementById('standings-body').innerHTML = `<tr><td colspan="10" class="text-red-500 text-center p-4">Failed to load league data.</td></tr>`;
                document.getElementById('scorers-grid').innerHTML = `<p class="text-red-500 text-center col-span-full">Failed to load league data.</p>`;
            }
        });

    </script>

</body>
</html>
